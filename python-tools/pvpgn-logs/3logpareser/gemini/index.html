<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvPGN –õ–æ–≥ –ê–Ω–∞–ª–∏–∑ Dashboard</title>
    <style>
        /* ... CSS —Å—Ç–∏–ª–æ–≤–µ—Ç–µ —Å–∞ —Å—ä—â–∏—Ç–µ –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –≤—ä–Ω—à–Ω–∏—è –≤–∏–¥ ... */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-box { background: #e9ecef; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-box strong { display: block; font-size: 1.5em; color: #007bff; }
        .stat-box span { font-size: 0.9em; color: #6c757d; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        th { background-color: #007bff; color: white; cursor: pointer; }
        tr:hover { background-color: #f1f1f1; }
        .error { color: red; font-weight: bold; }
        
        /* –°—Ç–∏–ª –∑–∞ Top 20 */
        .top-lists-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .top-list-box { background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6; }
        .top-list-box h3 { font-size: 1.1em; color: #333; margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .top-list-box ol { padding-left: 20px; }
        .top-list-box li { margin-bottom: 5px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéÆ PvPGN Log Dashboard</h1>
    <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –æ—Ç BNETD, D2GS –∏ D2CS –ª–æ–≥–æ–≤–µ—Ç–µ.</p>

    <div id="summary-section">
        <h2>üìä –û–±–æ–±—â–µ–Ω–∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
        <div id="stats-grid" class="stats-grid">
            <div class="stat-box"><strong>‚Äî</strong> <span>–û–±—â–æ –ò–≥—Ä–∏</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–°—Ä–µ–¥–Ω–∞ –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–ú–∞–∫—Å. –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–û–±—â–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –ì–µ—Ä–æ–∏</span></div>
        </div>
    </div>
    
    <div id="top-20-section">
        <h2>ü•á –¢–æ–ø 20 –ö–ª–∞—Å–∞—Ü–∏–∏</h2>
        <div id="top-lists-container" class="top-lists-container">
            </div>
    </div>

    <div id="active-games-section">
        <h2>üü¢ –í –ú–æ–º–µ–Ω—Ç–∞ –ê–∫—Ç–∏–≤–Ω–∏ –ò–≥—Ä–∏</h2>
        <table id="active-games-table">
            <thead>
                <tr>
                    <th>ID –Ω–∞ –ò–≥—Ä–∞—Ç–∞</th>
                    <th>–ò–º–µ</th>
                    <th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                    <th>–°—Ç–∞—Ä—Ç –í—Ä–µ–º–µ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="games-section">
        <h2>‚öîÔ∏è –ü–æ—Å–ª–µ–¥–Ω–∏ 50 –ó–∞–≤—ä—Ä—à–µ–Ω–∏ –ò–≥—Ä–∏</h2>
        <table id="games-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'games-table')">ID –Ω–∞ –ò–≥—Ä–∞—Ç–∞</th>
                    <th onclick="sortTable(1, 'games-table')">–ò–º–µ</th>
                    <th onclick="sortTable(2, 'games-table')">–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</th>
                    <th onclick="sortTable(3, 'games-table')">–°—Ç–∞—Ä—Ç –í—Ä–µ–º–µ</th>
                    <th onclick="sortTable(4, 'games-table')">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <div id="characters-section">
        <h2>üë§ –ì–µ—Ä–æ–∏ (Characters)</h2>
        <table id="chars-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'chars-table')">–ò–º–µ</th>
                    <th onclick="sortTable(1, 'chars-table')">–ù–∏–≤–æ</th>
                    <th onclick="sortTable(2, 'chars-table')">–ö–ª–∞—Å</th>
                    <th onclick="sortTable(3, 'chars-table')">–û–±—â–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è</th>
                    <th onclick="sortTable(4, 'chars-table')">–û–±—â–æ Ladder Update</th>
                    <th onclick="sortTable(5, 'chars-table')">–ü–æ—Å–ª–µ–¥–Ω–æ –í–∏–¥—è–Ω</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    const JSON_PATH = 'testalllogs.json';

    // --- –§–£–ù–ö–¶–ò–Ø –ó–ê –ß–û–í–ï–®–ö–ò –ß–ï–¢–ò–ú–ê –ü–†–û–î–™–õ–ñ–ò–¢–ï–õ–ù–û–°–¢ ---
    function formatDuration(totalSeconds) {
        if (!totalSeconds || totalSeconds < 1) return '0 —Å–µ–∫—É–Ω–¥–∏';

        const days = Math.floor(totalSeconds / (3600 * 24));
        const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = Math.round(totalSeconds % 60);
        
        let parts = [];
        if (days > 0) parts.push(`${days} –¥`);
        if (hours > 0) parts.push(`${hours} —á`);
        if (minutes > 0) parts.push(`${minutes} –º`);
        // –ü–æ–∫–∞–∑–≤–∞–º–µ —Å–µ–∫—É–Ω–¥–∏ —Å–∞–º–æ –∞–∫–æ –Ω—è–º–∞ –ø–æ-–≥–æ–ª–µ–º–∏ –µ–¥–∏–Ω–∏—Ü–∏
        if (seconds > 0 && parts.length < 2) parts.push(`${seconds} —Å`); 
        
        return parts.length > 0 ? parts.join(', ') : `${Math.round(totalSeconds)} —Å–µ–∫—É–Ω–¥–∏`;
    }
    
    function formatTimestamp(ts) {
        if (!ts) return '';
        const date = new Date(ts * 1000);
        return date.toLocaleString('bg-BG');
    }
    
    // --- –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –ó–ê–†–ï–ñ–î–ê–ù–ï –ù–ê –î–ê–ù–ù–ò ---
    async function loadData() {
        try {
            const response = await fetch(JSON_PATH);
            if (!response.ok) {
                throw new Error(`–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ JSON —Ñ–∞–π–ª–∞. –°—Ç–∞—Ç—É—Å: ${response.status}.`);
            }
            const data = await response.json();
            
            // –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∏–≥—Ä–∏—Ç–µ
            const allGames = data.games || [];
            const activeGames = allGames.filter(g => g.is_active);
            
            // –°–æ—Ä—Ç–∏—Ä–∞–º–µ –∑–∞–≤—ä—Ä—à–µ–Ω–∏—Ç–µ –∏–≥—Ä–∏ –ø–æ –≤—Ä–µ–º–µ –Ω–∞ –∫—Ä–∞–π –∏ –≤–∑–µ–º–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 50
            const completedGames = allGames
                .filter(g => !g.is_active)
                .sort((a, b) => b.end_ts - a.end_ts) // –°–æ—Ä—Ç–∏—Ä–∞–Ω–µ –ø–æ –Ω–∞–π-–Ω–æ–≤–∏—è –∫—Ä–∞–π
                .slice(0, 50); // –í–∑–∏–º–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 50
            
            // 1. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –û–±–æ–±—â–µ–Ω–∏—Ç–µ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            renderSummary(data.summary_stats);
            
            // 2. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –¢–æ–ø 20 –°–ø–∏—Å—ä—Ü–∏
            renderTopLists(data.summary_stats.top_lists);

            // 3. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ê–∫—Ç–∏–≤–Ω–∏ –ò–≥—Ä–∏
            renderActiveGamesTable(activeGames);
            
            // 4. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –¢–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ü–æ—Å–ª–µ–¥–Ω–∏ –ò–≥—Ä–∏
            renderGamesTable(completedGames);

            // 5. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –¢–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ì–µ—Ä–æ–∏
            renderCharactersTable(data.characters || []);

        } catch (error) {
            document.getElementById('summary-section').innerHTML = `<p class="error">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: ${error.message}</p>`;
            console.error(error);
        }
    }

    // --- –§–£–ù–ö–¶–ò–ò –ó–ê –†–ï–ù–î–ò–†–ê–ù–ï ---

    function renderSummary(stats) {
        const grid = document.getElementById('stats-grid');
        const avgDuration = stats.duration_stats_seconds.average_duration;
        const maxDuration = stats.duration_stats_seconds.maximum_duration;

        grid.innerHTML = `
            <div class="stat-box"><strong>${stats.total_unique_games}</strong> <span>–û–±—â–æ –ò–≥—Ä–∏</span></div>
            <div class="stat-box"><strong>${formatDuration(avgDuration)}</strong> <span>–°—Ä–µ–¥–Ω–∞ –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>${formatDuration(maxDuration)}</strong> <span>–ú–∞–∫—Å. –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>${stats.character_activity_stats.total_char_saves}</strong> <span>–û–±—â–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –ì–µ—Ä–æ–∏</span></div>
        `;
    }

    function renderTopLists(topLists) {
        const container = document.getElementById('top-lists-container');
        container.innerHTML = ''; // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ
        
        // 1. –ù–∞–π-–¥—ä–ª–≥–∏ –ò–≥—Ä–∏
        container.innerHTML += `
            <div class="top-list-box">
                <h3>–ù–∞–π-–î—ä–ª–≥–∏ –ò–≥—Ä–∏</h3>
                <ol>${topLists.longest_games.map(g => `
                    <li>${g.name} (${formatDuration(g.duration_secs)})</li>
                `).join('')}</ol>
            </div>
        `;
        
        // 2. –ù–∞–π-–ê–∫—Ç–∏–≤–Ω–∏ –ì–µ—Ä–æ–∏
        container.innerHTML += `
            <div class="top-list-box">
                <h3>–ù–∞–π-–ê–∫—Ç–∏–≤–Ω–∏ –ì–µ—Ä–æ–∏ (–ò–≥—Ä–∏)</h3>
                <ol>${topLists.most_active_characters.map(c => `
                    <li>${c.char_name} (${c.class}) - ${c.count} –∏–≥—Ä–∏</li>
                `).join('')}</ol>
            </div>
        `;
        
        // 3. –ù–∞–π-–ú–Ω–æ–≥–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è
        container.innerHTML += `
            <div class="top-list-box">
                <h3>–ù–∞–π-–ú–Ω–æ–≥–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è (CHARSAVE)</h3>
                <ol>${topLists.most_saves_characters.map(c => `
                    <li>${c.char_name} (${c.class}) - ${c.count} –∑–∞–ø–∞–∑–≤–∞–Ω–∏—è</li>
                `).join('')}</ol>
            </div>
        `;

        // 4. –ù–∞–π-–î—ä–ª–≥–∏ –ò–º–µ–Ω–∞
        container.innerHTML += `
            <div class="top-list-box">
                <h3>–ù–∞–π-–î—ä–ª–≥–∏ –ò–º–µ–Ω–∞ –Ω–∞ –ò–≥—Ä–∏</h3>
                <ol>${topLists.longest_game_names.map(g => `
                    <li>${g.name} (${g.length} –∑–Ω–∞–∫–∞)</li>
                `).join('')}</ol>
            </div>
        `;
    }

    function renderActiveGamesTable(games) {
        const tbody = document.getElementById('active-games-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        if (games.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">–ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ –∏–≥—Ä–∏.</td></tr>';
            return;
        }

        games.forEach(game => {
            const row = tbody.insertRow();
            row.insertCell().textContent = game.game_id;
            row.insertCell().textContent = game.name;
            row.insertCell().textContent = game.platform_type;
            row.insertCell().textContent = formatTimestamp(game.start_ts);
        });
    }

    function renderGamesTable(games) {
        const tbody = document.getElementById('games-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        games.forEach(game => {
            const row = tbody.insertRow();
            row.insertCell().textContent = game.game_id;
            row.insertCell().textContent = game.name;
            row.insertCell().textContent = formatDuration(game.duration_secs); // Human readable
            row.insertCell().textContent = formatTimestamp(game.start_ts);
            row.insertCell().textContent = game.platform_type;
        });
    }

    function renderCharactersTable(characters) {
        const tbody = document.getElementById('chars-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        characters.forEach(char => {
            const row = tbody.insertRow();
            row.insertCell().textContent = char.char_name;
            row.insertCell().textContent = char.level;
            row.insertCell().textContent = char.class; // –ü—ä–ª–Ω–æ –∏–º–µ
            row.insertCell().textContent = char.total_saves;
            row.insertCell().textContent = char.total_ladder_updates;
            row.insertCell().textContent = formatTimestamp(char.last_seen_ts);
        });
    }
    
    // --- –§–£–ù–ö–¶–ò–Ø –ó–ê –°–û–†–¢–ò–†–ê–ù–ï –ù–ê –¢–ê–ë–õ–ò–¶–ò (–Ω–µ–ø—Ä–æ–º–µ–Ω–µ–Ω–∞) ---
    function sortTable(n, tableId) {
        let table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById(tableId);
        switching = true;
        dir = "asc"; 
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                
                let xContent = isNaN(x.innerHTML) ? x.innerHTML.toLowerCase() : parseFloat(x.innerHTML);
                let yContent = isNaN(y.innerHTML) ? y.innerHTML.toLowerCase() : parseFloat(y.innerHTML);
                
                if (dir == "asc") {
                    if (xContent > yContent) {
                        shouldSwitch= true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (xContent < yContent) {
                        shouldSwitch= true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;      
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }


    // –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ –¥–∞–Ω–Ω–∏
    loadData();
</script>

</body>
</html>
