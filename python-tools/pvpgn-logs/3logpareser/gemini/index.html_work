<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvPGN –õ–æ–≥ –ê–Ω–∞–ª–∏–∑ Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-box { background: #e9ecef; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-box strong { display: block; font-size: 1.5em; color: #007bff; }
        .stat-box span { font-size: 0.9em; color: #6c757d; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        th { background-color: #007bff; color: white; cursor: pointer; }
        tr:hover { background-color: #f1f1f1; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéÆ PvPGN Log Dashboard</h1>
    <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –æ—Ç BNETD, D2GS –∏ D2CS –ª–æ–≥–æ–≤–µ—Ç–µ.</p>

    <div id="summary-section">
        <h2>üìä –û–±–æ–±—â–µ–Ω–∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
        <div id="stats-grid" class="stats-grid">
            <div class="stat-box"><strong>‚Äî</strong> <span>–û–±—â–æ –ò–≥—Ä–∏</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–°—Ä–µ–¥–Ω–∞ –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–ú–∞–∫—Å. –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–û–±—â–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –ì–µ—Ä–æ–∏</span></div>
            <div class="stat-box"><strong>‚Äî</strong> <span>–ù–∞–π-–î—ä–ª–≥–æ –ò–º–µ –Ω–∞ –ò–≥—Ä–∞</span></div>
        </div>
    </div>

    <div id="games-section">
        <h2>‚öîÔ∏è –ò–≥—Ä–∏ (Games)</h2>
        <table id="games-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'games-table')">ID –Ω–∞ –ò–≥—Ä–∞—Ç–∞</th>
                    <th onclick="sortTable(1, 'games-table')">–ò–º–µ</th>
                    <th onclick="sortTable(2, 'games-table')">–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç (—Å–µ–∫—É–Ω–¥–∏)</th>
                    <th onclick="sortTable(3, 'games-table')">–°—Ç–∞—Ä—Ç TS</th>
                    <th onclick="sortTable(4, 'games-table')">–ö—Ä–∞–π TS</th>
                    <th onclick="sortTable(5, 'games-table')">–ò–∑—Ç–æ—á–Ω–∏–∫</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <div id="characters-section">
        <h2>üë§ –ì–µ—Ä–æ–∏ (Characters)</h2>
        <table id="chars-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'chars-table')">–ò–º–µ</th>
                    <th onclick="sortTable(1, 'chars-table')">–ù–∏–≤–æ</th>
                    <th onclick="sortTable(2, 'chars-table')">–ö–ª–∞—Å</th>
                    <th onclick="sortTable(3, 'chars-table')">–û–±—â–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è</th>
                    <th onclick="sortTable(4, 'chars-table')">–û–±—â–æ Ladder Update</th>
                    <th onclick="sortTable(5, 'chars-table')">–ü–æ—Å–ª–µ–¥–Ω–æ –í–∏–¥—è–Ω TS</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    const JSON_PATH = 'testalllogs.json';

    // –ü–æ–º–æ—â–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Å–µ–∫—É–Ω–¥–∏ –≤ –ß–ß:–ú–ú:–°–°
    function formatDuration(seconds) {
        if (!seconds) return '0s';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.round(seconds % 60);
        let result = [];
        if (h > 0) result.push(h + '—á');
        if (m > 0) result.push(m + '–º');
        if (s > 0 || result.length === 0) result.push(s + '—Å');
        return result.join(' ');
    }
    
    // –ü–æ–º–æ—â–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Timestamp –≤ –¥–∞—Ç–∞/—á–∞—Å
    function formatTimestamp(ts) {
        if (!ts) return '';
        // –£–≤–µ—Ä–µ—Ç–µ —Å–µ, —á–µ TS –µ –≤–∞–ª–∏–¥–µ–Ω –Ω–æ–º–µ—Ä, –ø—Ä–µ–¥–∏ –¥–∞ –≥–æ —É–º–Ω–æ–∂–∏—Ç–µ
        const date = new Date(ts * 1000); 
        return date.toLocaleString('bg-BG');
    }

    // --- –§–£–ù–ö–¶–ò–Ø –ó–ê –°–û–†–¢–ò–†–ê–ù–ï –ù–ê –¢–ê–ë–õ–ò–¶–ò ---
    function sortTable(n, tableId) {
        let table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById(tableId);
        switching = true;
        // –ó–∞–¥–∞–≤–∞–º–µ –ø–æ—Å–æ–∫–∞ –Ω–∞ —Å–æ—Ä—Ç–∏—Ä–∞–Ω–µ: –≤—ä–∑—Ö–æ–¥—è—â–∞
        dir = "asc"; 
        
        // –¶–∏–∫—ä–ª, –¥–æ–∫–∞—Ç–æ –Ω–µ –±—ä–¥–µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ –ø—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                // –í–∑–µ–º–∞–Ω–µ –Ω–∞ –¥–≤–∞—Ç–∞ –µ–ª–µ–º–µ–Ω—Ç–∞ –∑–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –µ —á–∏—Å–ª–æ
                let xContent = isNaN(x.innerHTML) ? x.innerHTML.toLowerCase() : parseFloat(x.innerHTML);
                let yContent = isNaN(y.innerHTML) ? y.innerHTML.toLowerCase() : parseFloat(y.innerHTML);
                
                // –°—Ä–∞–≤–Ω—è–≤–∞–Ω–µ
                if (dir == "asc") {
                    if (xContent > yContent) {
                        shouldSwitch= true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (xContent < yContent) {
                        shouldSwitch= true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;      
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }
    
    // --- –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–ò–Ø –ó–ê –ó–ê–†–ï–ñ–î–ê–ù–ï –ù–ê –î–ê–ù–ù–ò ---
    async function loadData() {
        try {
            const response = await fetch(JSON_PATH);
            if (!response.ok) {
                throw new Error(`–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ JSON —Ñ–∞–π–ª–∞. –°—Ç–∞—Ç—É—Å: ${response.status}. –ú–æ–ª—è, —É–≤–µ—Ä–µ—Ç–µ —Å–µ, —á–µ ${JSON_PATH} –µ –¥–æ—Å—Ç—ä–ø–µ–Ω.`);
            }
            const data = await response.json();
            
            // 1. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –û–±–æ–±—â–µ–Ω–∏—Ç–µ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            renderSummary(data.summary_stats);
            
            // 2. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –¢–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ò–≥—Ä–∏
            renderGamesTable(data.games);

            // 3. –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –¢–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –ì–µ—Ä–æ–∏
            // –ü—Ä–µ–¥–∏ –¥–∞ —Ä–µ–Ω–¥–∏—Ä–∞–º–µ, –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –º–∞—Å–∏–≤—ä—Ç –µ –Ω–∞–ª–∏—á–µ–Ω –∏ –∏–º–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ
            if (data.characters && data.characters.length > 0) {
                 renderCharactersTable(data.characters);
            } else {
                 document.getElementById('chars-table').getElementsByTagName('tbody')[0].innerHTML = '<tr><td colspan="6" style="text-align: center;">–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –≥–µ—Ä–æ–∏.</td></tr>';
            }


        } catch (error) {
            document.getElementById('summary-section').innerHTML = `<p class="error">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: ${error.message}</p>`;
            console.error(error);
        }
    }

    // --- –§–£–ù–ö–¶–ò–Ø –ó–ê –†–ï–ù–î–ò–†–ê–ù–ï –ù–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---
    function renderSummary(stats) {
        const grid = document.getElementById('stats-grid');
        grid.innerHTML = `
            <div class="stat-box"><strong>${stats.total_unique_games}</strong> <span>–û–±—â–æ –ò–≥—Ä–∏</span></div>
            <div class="stat-box"><strong>${formatDuration(stats.duration_stats_seconds.average_duration)}</strong> <span>–°—Ä–µ–¥–Ω–∞ –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>${formatDuration(stats.duration_stats_seconds.maximum_duration)}</strong> <span>–ú–∞–∫—Å. –ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç</span></div>
            <div class="stat-box"><strong>${stats.character_activity_stats.total_char_saves}</strong> <span>–û–±—â–æ –ó–∞–ø–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –ì–µ—Ä–æ–∏</span></div>
            <div class="stat-box"><strong>${stats.game_name_stats.longest_name_game.name} (${stats.game_name_stats.longest_name_game.length} –∑–Ω.)</strong> <span>–ù–∞–π-–î—ä–ª–≥–æ –ò–º–µ –Ω–∞ –ò–≥—Ä–∞</span></div>
        `;
    }

    // --- –§–£–ù–ö–¶–ò–Ø –ó–ê –†–ï–ù–î–ò–†–ê–ù–ï –ù–ê –¢–ê–ë–õ–ò–¶–ê –° –ò–ì–†–ò ---
    function renderGamesTable(games) {
        const tbody = document.getElementById('games-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        games.forEach(game => {
            const row = tbody.insertRow();
            row.insertCell().textContent = game.game_id;
            row.insertCell().textContent = game.name;
            row.insertCell().textContent = game.duration_secs ? Math.round(game.duration_secs) : 'N/A';
            row.insertCell().textContent = formatTimestamp(game.start_ts_bnetd);
            row.insertCell().textContent = formatTimestamp(game.end_ts_bnetd);
            row.insertCell().textContent = game.source_logs.join(', ');
        });
    }

    // --- –§–£–ù–ö–¶–ò–Ø –ó–ê –†–ï–ù–î–ò–†–ê–ù–ï –ù–ê –¢–ê–ë–õ–ò–¶–ê –° –ì–ï–†–û–ò (–§–ò–ù–ê–õ–ù–ê –ö–û–†–ï–ö–¶–ò–Ø) ---
    function renderCharactersTable(characters) {
        const tbody = document.getElementById('chars-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        characters.forEach(char => {
            // insertRow() –µ –∫–æ—Ä–µ–∫—Ç–µ–Ω –∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏
            const row = tbody.insertRow(); 
            
            row.insertCell().textContent = char.char_name;
            row.insertCell().textContent = char.level;
            row.insertCell().textContent = char.class;
            row.insertCell().textContent = char.total_saves;
            row.insertCell().textContent = char.total_ladder_updates;
            row.insertCell().textContent = formatTimestamp(char.last_seen_ts);
        });
    }

    // –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ –¥–∞–Ω–Ω–∏
    loadData();
</script>

</body>
</html>
